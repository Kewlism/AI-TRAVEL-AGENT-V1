<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Travel Agent Command Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563EB; /* Royal Blue */
            --purple: #9333EA;
            --green: #10B981;
            --bg-color: #F3F4F6;
            --card-bg: #FFFFFF;
            --text-dark: #1F2937;
            --text-light: #6B7280;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        
        body {
            background-color: var(--bg-color);
            min-height: 100vh;
            color: var(--text-dark);
            padding-bottom: 50px;
        }

        /* --- HEADER --- */
        .command-header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.2);
            margin-bottom: 40px;
        }
        .command-header h1 { font-size: 2.5em; font-weight: 700; margin-bottom: 5px; }
        .command-header p { opacity: 0.9; font-weight: 400; }

        /* --- CONTAINER --- */
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }

        /* --- SETUP OVERLAY (Keep this for input) --- */
        #setup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(17, 24, 39, 0.95);
            z-index: 2000;
            display: flex; justify-content: center; align-items: center;
        }
        .setup-card {
            background: white; padding: 40px; width: 500px;
            border-radius: 20px; text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark); }
        .form-input {
            width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 10px;
            font-size: 1em; outline: none; transition: 0.3s;
        }
        .form-input:focus { border-color: var(--primary); }
        .btn-primary {
            background: var(--primary); color: white; border: none; padding: 15px 30px;
            border-radius: 12px; font-weight: 600; font-size: 1.1em;
            cursor: pointer; width: 100%; transition: 0.2s;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2); }

        /* --- TRIP DETAILS CARDS --- */
        .details-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;
            margin-bottom: 30px;
        }
        .detail-card {
            background: var(--card-bg); padding: 25px; border-radius: 16px;
            text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .detail-card:hover { transform: translateY(-5px); }
        .detail-icon { font-size: 3em; margin-bottom: 10px; display: block; }
        .detail-value { font-size: 1.4em; font-weight: 700; color: var(--text-dark); }
        .detail-label { color: var(--text-light); font-size: 0.9em; font-weight: 500; }

        /* --- BUDGET BAR --- */
        .budget-section {
            background: var(--card-bg); padding: 20px 30px; border-radius: 16px;
            margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            cursor: pointer; position: relative;
        }
        .budget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .budget-progress {
            height: 12px; background: #E5E7EB; border-radius: 6px; overflow: hidden;
        }
        .budget-fill {
            height: 100%; background: linear-gradient(90deg, #EF4444 0%, #F87171 100%); width: 0%; transition: width 1s ease;
        }
        .budget-dropdown {
            display: none; margin-top: 20px; border-top: 1px solid #E5E7EB; padding-top: 15px;
            animation: fadeIn 0.3s ease;
        }
        .budget-dropdown.active { display: block; }
        .budget-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95em; }

        /* --- AGENT CARDS --- */
        .agents-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px; }
        .agent-card {
            background: var(--card-bg); border-radius: 20px; overflow: hidden;
            box-shadow: 0 10px 15px rgba(0,0,0,0.05);
            transition: transform 0.2s; cursor: pointer;
        }
        .agent-card:hover { transform: translateY(-5px); }
        
        .agent-header { padding: 30px; color: white; text-align: center; }
        .agent-header.research { background: var(--purple); }
        .agent-header.booking { background: var(--green); }
        
        .agent-icon-large { font-size: 3.5em; margin-bottom: 10px; }
        .agent-title { font-size: 1.5em; font-weight: 700; }
        
        .agent-stats {
            padding: 20px; display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 10px; text-align: center;
        }
        .stat-val { font-size: 1.8em; font-weight: 700; color: var(--text-dark); }
        .stat-label { font-size: 0.75em; color: var(--text-light); font-weight: 600; letter-spacing: 0.5px; }

        /* --- ITINERARY --- */
        .itinerary-section { background: var(--card-bg); border-radius: 20px; padding: 40px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .day-header { font-size: 1.5em; font-weight: 700; margin: 30px 0 20px; padding-bottom: 10px; border-bottom: 2px solid #E5E7EB; }
        
        .activity-item {
            display: flex; gap: 20px; margin-bottom: 20px; align-items: center;
            padding: 20px; background: #F9FAFB; border-radius: 12px;
            border-left: 5px solid var(--primary); transition: 0.2s;
        }
        .activity-item:hover { background: #F3F4F6; }
        .time-badge { 
            background: var(--text-dark); color: white; padding: 8px 12px; 
            border-radius: 8px; font-weight: 600; font-size: 0.9em; min-width: 85px; text-align: center;
        }
        .reject-btn {
            width: 40px; height: 40px; border-radius: 50%; border: none;
            background: #FEE2E2; color: #EF4444; font-size: 1.2em;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .reject-btn:hover { background: #EF4444; color: white; transform: rotate(90deg); }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 3000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 16px; width: 600px; max-height: 80vh; overflow-y: auto; }

        /* ANIMATIONS */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .dashboard-content { display: none; animation: fadeIn 0.8s ease; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="setup-overlay">
        <div class="setup-card">
            <h2 style="margin-bottom: 10px; color: var(--text-dark);">‚úàÔ∏è Plan Your Trip</h2>
            <p style="color: var(--text-light); margin-bottom: 30px;">AI Autonomous Agent System</p>
            
            <form onsubmit="startTrip(event)" id="trip-form">
                <div class="form-group">
                    <label>Destination</label>
                    <input type="text" id="destination" class="form-input" value="Rome" required>
                </div>
                <div style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex:1;">
                        <label>Duration (Days)</label>
                        <select id="days" class="form-input">
                            <option value="3">3 Days</option>
                            <option value="5">5 Days</option>
                            <option value="7" selected>7 Days</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label>Travelers</label>
                        <select id="travelers" class="form-input">
                            <option value="1">1 Adult</option>
                            <option value="2" selected>2 Adults</option>
                            <option value="4">Family (4)</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Experience</label>
                    <select id="experience" class="form-input">
                        <option value="Premium" selected>‚≠ê Premium</option>
                        <option value="Budget">üéí Budget</option>
                        <option value="Adventure">üåø Adventure</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Plan Trip üöÄ</button>
            </form>

            <div id="loader" style="display: none;">
                <div class="spinner"></div>
                <p style="color: var(--text-light);">Agents are working...</p>
            </div>
        </div>
    </div>

    <div class="command-header">
        <h1>üèùÔ∏è AI Travel Agent Command Center</h1>
        <p>Autonomous Planning & Booking System</p>
    </div>

    <div class="container dashboard-content" id="dashboard">
        
        <div class="details-grid">
            <div class="detail-card">
                <span class="detail-icon">üèõÔ∏è</span>
                <div class="detail-value" id="display-dest">Rome</div>
                <div class="detail-label">Destination</div>
            </div>
            <div class="detail-card">
                <span class="detail-icon">üìÖ</span>
                <div class="detail-value" id="display-days">7 Days</div>
                <div class="detail-label">Duration</div>
            </div>
            <div class="detail-card">
                <span class="detail-icon">üë•</span>
                <div class="detail-value" id="display-travelers">2 Adults</div>
                <div class="detail-label">Travelers</div>
            </div>
            <div class="detail-card">
                <span class="detail-icon">‚≠ê</span>
                <div class="detail-value" id="display-style">Premium</div>
                <div class="detail-label">Experience</div>
            </div>
        </div>

        <div class="budget-section" onclick="toggleBudget()">
            <div class="budget-header">
                <h3 style="font-size: 1.1em;">Budget Progress</h3>
                <div style="font-weight: 700; font-size: 1.2em;" id="total-budget">$0 / Estimated</div>
            </div>
            <div class="budget-progress">
                <div class="budget-fill" style="width: 100%;"></div> </div>
            <div style="margin-top: 10px; color: #EF4444; font-size: 0.9em;">
                ‚ö†Ô∏è Click to view cost breakdown
            </div>
            
            <div class="budget-dropdown" id="budget-dropdown">
                <div id="budget-list"></div>
            </div>
        </div>

        <div class="agents-grid">
            <div class="agent-card" onclick="openModal('research')">
                <div class="agent-header research">
                    <div class="agent-icon-large">üîç</div>
                    <div class="agent-title">Research Agent</div>
                    <div style="opacity: 0.9;">‚úì Completed</div>
                </div>
                <div class="agent-stats">
                    <div>
                        <div class="stat-val" id="res-count">0</div>
                        <div class="stat-label">ATTRACTIONS</div>
                    </div>
                    <div>
                        <div class="stat-val">12</div>
                        <div class="stat-label">RESTAURANTS</div>
                    </div>
                    <div>
                        <div class="stat-val">5</div>
                        <div class="stat-label">HIDDEN GEMS</div>
                    </div>
                </div>
            </div>

            <div class="agent-card" onclick="openModal('booking')">
                <div class="agent-header booking">
                    <div class="agent-icon-large">üè®</div>
                    <div class="agent-title">Booking Agent</div>
                    <div style="opacity: 0.9;">‚úì Completed</div>
                </div>
                <div class="agent-stats">
                    <div>
                        <div class="stat-val">1</div>
                        <div class="stat-label">HOTELS</div>
                    </div>
                    <div>
                        <div class="stat-val">2</div>
                        <div class="stat-label">FLIGHTS</div>
                    </div>
                    <div>
                        <div class="stat-val" id="book-count">0</div>
                        <div class="stat-label">ACTIVITIES</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="itinerary-section" id="itinerary-container">
            </div>

    </div>

    <div id="modal-research" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom: 20px;">
                <h3>üîç Research Findings</h3>
                <span onclick="closeModal('research')" style="cursor:pointer; font-size:1.5em;">&times;</span>
            </div>
            <div id="research-list"></div>
        </div>
    </div>
    <div id="modal-booking" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom: 20px;">
                <h3>üè® Booking Options</h3>
                <span onclick="closeModal('booking')" style="cursor:pointer; font-size:1.5em;">&times;</span>
            </div>
            <div id="booking-list"></div>
        </div>
    </div>

    <script>
        let tripData = {};
        
        async function startTrip(event) {
            event.preventDefault();
            document.getElementById('trip-form').style.display = 'none';
            document.getElementById('loader').style.display = 'block';

            const payload = {
                destination: document.getElementById('destination').value,
                days: parseInt(document.getElementById('days').value),
                travelers: parseInt(document.getElementById('travelers').value),
                experience: document.getElementById('experience').value
            };

            // Update Top Cards
            document.getElementById('display-dest').textContent = payload.destination;
            document.getElementById('display-days').textContent = payload.days + " Days";
            document.getElementById('display-travelers').textContent = payload.travelers + (payload.travelers > 1 ? " Adults" : " Adult");
            document.getElementById('display-style').textContent = payload.experience;

            try {
                const res = await fetch('/start_plan', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                tripData = await res.json();
                
                if(tripData.error) throw new Error("Agent Failed");

                renderAll();
                document.getElementById('setup-overlay').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
            } catch (e) {
                alert("Connection failed. Try again.");
                location.reload();
            }
        }

        function renderAll() {
            // Stats
            document.getElementById('res-count').innerText = tripData.research_findings.length;
            document.getElementById('book-count').innerText = tripData.booking_options.length;

            // Modals
            const rList = document.getElementById('research-list');
            rList.innerHTML = tripData.research_findings.map(i => `<div style="padding:15px; border-bottom:1px solid #eee;"><b>${i.name}</b><br><small style="color:#666;">${i.type}</small></div>`).join('');
            
            const bList = document.getElementById('booking-list');
            bList.innerHTML = tripData.booking_options.map(i => `<div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;"><div><b>${i.name}</b><br><small style="color:#666;">${i.category}</small></div><span style="font-weight:bold;">$${i.cost}</span></div>`).join('');

            // Itinerary
            const container = document.getElementById('itinerary-container');
            container.innerHTML = "";
            
            tripData.itinerary.forEach((day, dIdx) => {
                let html = `<div class="day-header">Day ${day.day}: ${day.theme}</div>`;
                day.activities.forEach((act, aIdx) => {
                    html += `
                    <div class="activity-item" id="card-${dIdx}-${aIdx}">
                        <div class="time-badge">${act.time}</div>
                        <div style="flex:1;">
                            <div style="font-weight:700; font-size:1.1em;">${act.activity}</div>
                            <div style="color:#6B7280; font-size:0.9em; margin-top:2px;">${act.description}</div>
                            <div style="color:#10B981; font-weight:600; font-size:0.9em; margin-top:5px;">$${act.cost}</div>
                        </div>
                        <button class="reject-btn" onclick="swapActivity(${dIdx}, ${aIdx})" title="Reject & Replace">‚úñ</button>
                    </div>`;
                });
                container.innerHTML += html;
            });

            calculateBudget();
        }

        function calculateBudget() {
            let total = 0;
            let breakdownHTML = "";

            tripData.booking_options.forEach(opt => {
                total += opt.cost;
                breakdownHTML += `<div class="budget-item"><span>${opt.name}</span><span>$${opt.cost}</span></div>`;
            });

            tripData.itinerary.forEach(day => {
                day.activities.forEach(act => {
                    if(act.cost > 0) {
                        total += act.cost;
                        breakdownHTML += `<div class="budget-item"><span>${act.activity}</span><span>$${act.cost}</span></div>`;
                    }
                });
            });

            document.getElementById('total-budget').innerText = `$${total} / Estimated`;
            document.getElementById('budget-list').innerHTML = breakdownHTML + `<div style="border-top:2px solid #eee; margin-top:10px; padding-top:10px; font-weight:bold; display:flex; justify-content:space-between;"><span>TOTAL</span><span>$${total}</span></div>`;
        }

        async function swapActivity(dIdx, aIdx) {
            const card = document.getElementById(`card-${dIdx}-${aIdx}`);
            const oldAct = tripData.itinerary[dIdx].activities[aIdx];
            
            card.style.opacity = "0.6";
            card.innerHTML = `<div style="padding:10px; text-align:center; width:100%;">üîÑ Finding Agent-Verified Alternative...</div>`;

            try {
                const res = await fetch('/replace_activity', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        destination: tripData.trip_details.destination,
                        old_activity: oldAct.activity,
                        experience: tripData.trip_details.experience
                    })
                });
                const newAct = await res.json();
                tripData.itinerary[dIdx].activities[aIdx] = newAct;

                card.outerHTML = `
                    <div class="activity-item" id="card-${dIdx}-${aIdx}" style="border-left-color: #EF4444; animation: fadeIn 0.5s;">
                        <div class="time-badge">${newAct.time}</div>
                        <div style="flex:1;">
                            <div style="font-weight:700; font-size:1.1em;">${newAct.activity}</div>
                            <div style="color:#6B7280; font-size:0.9em; margin-top:2px;">${newAct.description}</div>
                            <div style="color:#10B981; font-weight:600; font-size:0.9em; margin-top:5px;">$${newAct.cost}</div>
                        </div>
                        <button class="reject-btn" onclick="swapActivity(${dIdx}, ${aIdx})">‚úñ</button>
                    </div>`;
                
                calculateBudget();
            } catch (e) {
                alert("Swap failed");
                renderAll();
            }
        }

        function toggleBudget() { document.getElementById('budget-dropdown').classList.toggle('active'); }
        function openModal(id) { document.getElementById('modal-'+id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById('modal-'+id).style.display = 'none'; }
    </script>
</body>
</html>